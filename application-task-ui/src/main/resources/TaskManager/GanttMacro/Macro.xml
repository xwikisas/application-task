<?xml version="1.1" encoding="UTF-8"?>

<!--
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This is free software; you can redistribute it and/or modify it
 * under the terms of the GNU Lesser General Public License as
 * published by the Free Software Foundation; either version 2.1 of
 * the License, or (at your option) any later version.
 *
 * This software is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this software; if not, write to the Free
 * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
 * 02110-1301 USA, or see the FSF site: http://www.fsf.org.
-->

<xwikidoc version="1.4" reference="TaskManager.GanttMacro.Macro" locale="">
  <web>TaskManager.GanttMacro</web>
  <name>Macro</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <creator>xwiki:XWiki.Admin</creator>
  <parent>xwiki:TaskManager.GanttMacro.Macro</parent>
  <author>xwiki:XWiki.Admin</author>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <version>1.1</version>
  <title>Macro</title>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <content>{{taskgantt/}}</content>
  <object>
    <name>TaskManager.GanttMacro.Macro</name>
    <number>0</number>
    <className>XWiki.JavaScriptExtension</className>
    <guid>20ebfcab-84f8-4525-b1b5-c053c1e425f0</guid>
    <class>
      <name>XWiki.JavaScriptExtension</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <cache>
        <cache>0</cache>
        <defaultValue>long</defaultValue>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <freeText>forbidden</freeText>
        <largeStorage>0</largeStorage>
        <multiSelect>0</multiSelect>
        <name>cache</name>
        <number>5</number>
        <prettyName>Caching policy</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>long|short|default|forbid</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </cache>
      <code>
        <contenttype>PureText</contenttype>
        <disabled>0</disabled>
        <editor>PureText</editor>
        <name>code</name>
        <number>2</number>
        <prettyName>Code</prettyName>
        <rows>20</rows>
        <size>50</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <parse>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>parse</name>
        <number>4</number>
        <prettyName>Parse content</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </parse>
      <use>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <freeText>forbidden</freeText>
        <largeStorage>0</largeStorage>
        <multiSelect>0</multiSelect>
        <name>use</name>
        <number>3</number>
        <prettyName>Use this extension</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>currentPage|onDemand|always</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </use>
    </class>
    <property>
      <cache>forbid</cache>
    </property>
    <property>
      <code>function addStyles(svgElem) {
  var defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
  defs.innerHTML += `
&lt;linearGradient id="fadeGrad" fill="white"&gt;
  &lt;stop offset="30%" stop-color="white" stop-opacity="1" /&gt;
  &lt;stop offset="60%" stop-color="white" stop-opacity=".4" /&gt;
  &lt;stop offset="100%" stop-color="white" stop-opacity="0" /&gt;
&lt;/linearGradient&gt;
&lt;mask id="fademask" maskContentUnits="objectBoundingBox"&gt;
  &lt;rect width="1" height="1" fill="url(#fadeGrad)"/&gt;
&lt;/mask&gt;

&lt;filter id="rounded-corners" x="-2.5%" width="105%" y="-5%" height="110%"&gt;
  &lt;feFlood flood-color="rgba(255,60,60)"/&gt;
  &lt;feGaussianBlur stdDeviation="4"/&gt;
  &lt;feComponentTransfer&gt;
    &lt;feFuncA type="table"tableValues="0 0 0 1"/&gt;
  &lt;/feComponentTransfer&gt;
  &lt;feComponentTransfer&gt;
    &lt;feFuncA type="table"tableValues="0 1 1 1 1 1 1 1"/&gt;
  &lt;/feComponentTransfer&gt;
  &lt;feComposite operator="over" in="SourceGraphic"/&gt;
&lt;/filter&gt;
`;
  svgElem.setAttribute('height', svgElem.getAttribute('height') - 100);
  svgElem.appendChild(defs);
}</code>
    </property>
    <property>
      <name>Add svg styles</name>
    </property>
    <property>
      <parse>0</parse>
    </property>
    <property>
      <use>onDemand</use>
    </property>
  </object>
  <object>
    <name>TaskManager.GanttMacro.Macro</name>
    <number>0</number>
    <className>XWiki.StyleSheetExtension</className>
    <guid>d0ae2c28-2352-4c27-88c8-2f7931d74a5c</guid>
    <class>
      <name>XWiki.StyleSheetExtension</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <cache>
        <cache>0</cache>
        <defaultValue>long</defaultValue>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <freeText>forbidden</freeText>
        <largeStorage>0</largeStorage>
        <multiSelect>0</multiSelect>
        <name>cache</name>
        <number>5</number>
        <prettyName>Caching policy</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>long|short|default|forbid</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </cache>
      <code>
        <contenttype>PureText</contenttype>
        <disabled>0</disabled>
        <editor>PureText</editor>
        <name>code</name>
        <number>2</number>
        <prettyName>Code</prettyName>
        <rows>20</rows>
        <size>50</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <contentType>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <freeText>forbidden</freeText>
        <largeStorage>0</largeStorage>
        <multiSelect>0</multiSelect>
        <name>contentType</name>
        <number>6</number>
        <prettyName>Content Type</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>CSS|LESS</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </contentType>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <parse>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>parse</name>
        <number>4</number>
        <prettyName>Parse content</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </parse>
      <use>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <freeText>forbidden</freeText>
        <largeStorage>0</largeStorage>
        <multiSelect>0</multiSelect>
        <name>use</name>
        <number>3</number>
        <prettyName>Use this extension</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>currentPage|onDemand|always</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </use>
    </class>
    <property>
      <cache>long</cache>
    </property>
    <property>
      <code>.gantt {
  .bar-label {
    fill: #000000;
    font-weight: bold;
  }
  .bar-wrapper:hover.statusToDo .bar-progress {
    fill: #5ed65e;
  }
  .bar-wrapper.statusToDo .bar-progress {
    fill: lightgreen;
  }
  .bar-wrapper:hover.statusDone .bar-progress {
    fill: gold;
  }
  .bar-wrapper.statusDone .bar-progress {
    fill: #f4e64b;
  }
  .bar-wrapper.statusInProgress {
    fill: lightblue;
  }
  .bar-wrapper.noDueDate {
    text, text.big {
      filter:url(#rounded-corners);
      fill:white;
    }
    .bar, .bar-progress {
      mask: url('#fademask');
    }
  }
}</code>
    </property>
    <property>
      <contentType>LESS</contentType>
    </property>
    <property>
      <name>Override Frappe Gantt styles</name>
    </property>
    <property>
      <parse>0</parse>
    </property>
    <property>
      <use>onDemand</use>
    </property>
  </object>
  <object>
    <name>TaskManager.GanttMacro.Macro</name>
    <number>0</number>
    <className>XWiki.WikiMacroClass</className>
    <guid>f1941f8a-9d1a-4d4a-b2b3-e332d10ab507</guid>
    <class>
      <name>XWiki.WikiMacroClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <async_cached>
        <defaultValue>0</defaultValue>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType/>
        <name>async_cached</name>
        <number>13</number>
        <prettyName>Cached</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </async_cached>
      <async_context>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <freeText>forbidden</freeText>
        <largeStorage>0</largeStorage>
        <multiSelect>1</multiSelect>
        <name>async_context</name>
        <number>14</number>
        <prettyName>Context elements</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator>, </separator>
        <separators>|, </separators>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <values>action=Action|doc.reference=Document|icon.theme=Icon theme|locale=Language|rendering.defaultsyntax=Default syntax|rendering.restricted=Restricted|rendering.targetsyntax=Target syntax|request.base=Request base URL|request.parameters=Request parameters|request.url=Request URL|request.wiki=Request wiki|user=User|wiki=Wiki</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </async_context>
      <async_enabled>
        <defaultValue>0</defaultValue>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType/>
        <name>async_enabled</name>
        <number>12</number>
        <prettyName>Asynchronous rendering</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </async_enabled>
      <code>
        <disabled>0</disabled>
        <editor>Text</editor>
        <name>code</name>
        <number>10</number>
        <prettyName>Macro code</prettyName>
        <rows>20</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <contentDescription>
        <contenttype>PureText</contenttype>
        <disabled>0</disabled>
        <editor>PureText</editor>
        <name>contentDescription</name>
        <number>9</number>
        <prettyName>Content description (Not applicable for "No content" type)</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </contentDescription>
      <contentJavaType>
        <cache>0</cache>
        <defaultValue>Unknown</defaultValue>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <freeText>allowed</freeText>
        <largeStorage>1</largeStorage>
        <multiSelect>0</multiSelect>
        <name>contentJavaType</name>
        <number>8</number>
        <picker>1</picker>
        <prettyName>Macro content type</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator>|</separator>
        <separators>|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>Unknown|Wiki</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </contentJavaType>
      <contentType>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <freeText>forbidden</freeText>
        <largeStorage>0</largeStorage>
        <multiSelect>0</multiSelect>
        <name>contentType</name>
        <number>7</number>
        <prettyName>Macro content availability</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator>|</separator>
        <separators>|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>Optional|Mandatory|No content</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </contentType>
      <defaultCategory>
        <disabled>0</disabled>
        <name>defaultCategory</name>
        <number>4</number>
        <prettyName>Default category</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </defaultCategory>
      <description>
        <contenttype>PureText</contenttype>
        <disabled>0</disabled>
        <editor>PureText</editor>
        <name>description</name>
        <number>3</number>
        <prettyName>Macro description</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </description>
      <id>
        <disabled>0</disabled>
        <name>id</name>
        <number>1</number>
        <prettyName>Macro id</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </id>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>2</number>
        <prettyName>Macro name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <priority>
        <disabled>0</disabled>
        <name>priority</name>
        <number>11</number>
        <numberType>integer</numberType>
        <prettyName>Priority</prettyName>
        <size>10</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.NumberClass</classType>
      </priority>
      <supportsInlineMode>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>supportsInlineMode</name>
        <number>5</number>
        <prettyName>Supports inline mode</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </supportsInlineMode>
      <visibility>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <freeText>forbidden</freeText>
        <largeStorage>0</largeStorage>
        <multiSelect>0</multiSelect>
        <name>visibility</name>
        <number>6</number>
        <prettyName>Macro visibility</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator>|</separator>
        <separators>|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>Current User|Current Wiki|Global</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </visibility>
    </class>
    <property>
      <async_cached>0</async_cached>
    </property>
    <property>
      <async_context/>
    </property>
    <property>
      <async_enabled>0</async_enabled>
    </property>
    <property>
      <code>{{velocity}}
#set ($mainReference = $services.model.createDocumentReference('', 'TaskManager', 'TaskManagerClass'))
#if (!$services.licensing.licensor.hasLicensureForEntity($mainReference))
  {{missingLicenseMessage extensionName="taskmanager.extension.name"/}}
#else
  #if(!$ganttCounter)
   #set($ganttCounter = 0)
  #else
   #set($ganttCounter = $ganttCounter + 1)
  #end
  #set ($ganttId = "gantt${ganttCounter}")

  #if("$!request.minify" == 'false')
    #set($frappe_js_path = $services.webjars.url('org.webjars.npm:frappe-gantt', "dist/frappe-gantt.js"))
  #else
    #set($frappe_js_path = $services.webjars.url('org.webjars.npm:frappe-gantt', "dist/frappe-gantt.min.js"))
  #end

  #set($discard = $xwiki.linkx.use(
      $services.webjars.url('org.webjars.npm:frappe-gantt', 'dist/frappe-gantt.css'),
      {'type': 'text/css', 'rel': 'stylesheet'}
  ))
  #set($discard = $xwiki.ssx.use('TaskManager.GanttMacro.Macro')) ## Override default frappe styles
  #set($discard = $xwiki.jsx.use('TaskManager.GanttMacro.Macro')) ## Override default frappe styles for svg styles/patterns
  #set($dateFormat = $services.datemacro.configuration.storageDateFormat)
  #set($dateTimeFormatter = $xwiki.jodatime.getDateTimeFormatterForPattern($dateFormat))

  #set($baseQuery = '?xpage=plain&amp;outputSyntax=plain')
  #set($jsonSourceURL = "${xwiki.getDocument('TaskManager.GanttMacro.JSONTaskSource').getURL('get')}${baseQuery}")
  #set($query = '')
  #if ($xcontext.macro.params.hideNoDueDate)
    #set($query = $query + "&amp;hideNoDueDate=$escapetool.url($xcontext.macro.params.hideNoDueDate)")
  #end
  #if ($xcontext.macro.params.projects)
    #set($query = $query + "&amp;projects=$escapetool.url($xcontext.macro.params.projects)")
  #end
  #if ($xcontext.macro.params.assignees)
    #set($query = $query + "&amp;assignees=$escapetool.url($xcontext.macro.params.assignees)")
  #end
  #if ($xcontext.macro.params.reporters)
    #set($query = $query + "&amp;reporters=$escapetool.url($xcontext.macro.params.reporters)")
  #end
  #if ($xcontext.macro.params.from)
    #set($fromDate = $xwiki.jodatime.dateTime.parse($xcontext.macro.params.from, $dateTimeFormatter).getMillis())
    #set($query = $query + "&amp;from=$escapetool.url($fromDate)")
  #end
  #if ($xcontext.macro.params.to)
    #set($toDate = $xwiki.jodatime.dateTime.parse($xcontext.macro.params.to, $dateTimeFormatter).getMillis())
    #set($query = $query + "&amp;to=$escapetool.url($toDate)")
  #end
  #if ($xcontext.macro.params.spaces)
    #set($query = $query + "&amp;spaces=${escapetool.url($xcontext.macro.params.spaces).replace('\','%5C')}")
  #end

  #set($readonlyError = $escapetool.html($escapetool.javascript($services.localization.render("taskmanager.gantt.taskEdit.error.readonly"))))
  #set($successMessage = $escapetool.html($escapetool.javascript($services.localization.render("taskmanager.gantt.taskEdit.success"))))
  #set($genericError = $escapetool.javascript($escapetool.html($services.localization.render('taskmanager.gantt.taskEdit.error.generic'))))
  #set($noDueDateMessage = $escapetool.javascript($escapetool.html($services.localization.render('taskmanager.gantt.task.noDueDate'))))

{{html}}
&lt;div id="${ganttId}"&gt;
&lt;script type='text/javascript'&gt;
//&lt;![CDATA[
var ${ganttId};
const updateService = "$xwiki.getURL('TaskManager.GanttMacro.UpdateService')?xpage=plain&amp;outputSyntax=plain&amp;";
function canEdit(task) {
  return (!$xcontext.macro.params.readonly);
}

function formatTask(task) {
  if(task.custom_class.split(/\s+/).includes('noDueDate')) {
    task.name = task.actualName + " - $noDueDateMessage";
  } else {
    task.name = task.actualName;
  }
  task.start = new Date(task.start);
  task.end = new Date(task.end);
  task.editHack = {
    oldProgress:task.progress,
    oldStartDate:task.start,
    oldEndDate:task.end,
  };
}

function escapeHTML(originalString) {
  return originalString.replace(/&amp;/g, '&amp;amp;')
  .replace(/&lt;/g, '&amp;lt;')
  .replace(/&gt;/g, '&amp;gt;')
  .replace(/"/g, '&amp;quot;')
  .replace(/'/g, '&amp;#39;');
}
function unescapeHTML(originalString) {
  return originalString.replace('&amp;amp;', /&amp;/g)
  .replace('&amp;lt;', /&lt;/g)
  .replace('&amp;gt;', /&gt;/g)
  .replace('&amp;quot;', /"/g)
  .replace('&amp;#39;', /'/g);
}

require(['jquery', "$frappe_js_path"], function(jQuery){
  function redrawBar(task) {
    formatTask(task); // rename if noDueDate
    let _bar = ${ganttId}.bars.find((bar) =&gt; bar.task === task);
    console.log(task)
    _bar.update_bar_position({x:_bar.compute_x()});
    _bar.group.setAttribute('class', 'bar-wrapper ' + (task.custom_class || ''));
    _bar.bar_group.getElementsByClassName('bar-label')[0].innerHTML = task.name;
    task.editHack.oldStartDate = task.start;
    task.editHack.oldEndDate = task.end;
    task.editHack.oldProgress = task.progress;
  }
  function fetch_and_redraw(task) {
    return fetch("${jsonSourceURL}&amp;taskId=" + encodeURIComponent(unescapeHTML(task.id)))
      .then(response =&gt; response.json()).then(newTaskData =&gt; {
        if(newTaskData.length != 1) {
          redrawBar(task);
          new XWiki.widgets.Notification("$genericError", 'error', '20');
          return;
        }
        newTaskData = newTaskData[0];
        formatTask(newTaskData);
        let updateHappened = !(task.editHack.oldStartDate.getTime() == newTaskData.start.getTime() &amp;&amp;
                               task.editHack.oldEndDate.getTime() == newTaskData.end.getTime() &amp;&amp;
                               task.editHack.oldProgress == newTaskData.progress);

        Object.assign(task, newTaskData);
        redrawBar(task);

        if (!updateHappened) {
          // data.success is true even if the document could not be saved with the new data
          // (eg. malformed parameters)
          new XWiki.widgets.Notification("$genericError", 'error', '20');
        } else {
          new XWiki.widgets.Notification("$successMessage", 'info', '20');
        }
    });
  }
  //Add custom svg markup when rendering Gantt
  Gantt.prototype['_render'] = Gantt.prototype['render'];
  Gantt.prototype['render'] = function() {
    const result = this['_render'](...arguments);
    addStyles(this['$svg']);
    return result;
  };

  fetch("${jsonSourceURL}${query}").then(response =&gt; response.json()).then(tasks =&gt; {
    tasks.forEach(formatTask);
    console.log(tasks);

    if(tasks.length == 0) {
      jQuery("#${ganttId}").append('Gantt: No tasks to show');
      return;
    }
    ${ganttId} = new Gantt("#${ganttId}", tasks, {
      view_mode_select: true,
      view_mode: 'Day',
      popup_trigger: null,
      padding: 10,
      column_width: 24,
      language: "$xwiki.getLocalePreference()",
      on_click: function (task) {
        window.open(task.link).focus();
      },
      on_progress_change: function (task, newProgress) {
        if (newProgress == task.editHack.oldProgress) {
          // useless progress change (event fires on any click, quirk of frappe-gantt)
          return;
        }
        if (!canEdit(task)) {
          task.progress = task.editHack.oldProgress;
          redrawBar(task);
          new XWiki.widgets.Notification("$errorOnEdit", 'error', '20');
          return;
        }

        let params = new URLSearchParams({
          taskDocument: task.id,
          progress: newProgress
        });
        jQuery.ajax( updateService + params ).success(function(data) {
          if (data.success == true) {
            fetch_and_redraw(task);
          } else {
            console.log(data);
            new XWiki.widgets.Notification(escapeHTML(data.reason), 'error', '20');
          }
        }).error(e =&gt; console.log('Error when updating progress:', e));
      },
      on_view_change: function(mode) {
        //empty
      },
      on_date_change: function (task, newStartDate, newEndDate) {
        // (Frappe automatically subtracts 1s from the real end date)
        newEndDate.setSeconds(newEndDate.getSeconds() + 1);
        if (newStartDate.getTime() == task.editHack.oldStartDate.getTime() &amp;&amp;
            newEndDate.getTime() == task.editHack.oldEndDate.getTime()) {
          // Useless progress change (event fires on any click, quirk of frappe-gantt)
          return;
        }
        if (!canEdit(task)) {
          task.start = task.editHack.oldStartDate;
          task.end = task.editHack.oldEndDate;
          redrawBar(task);
          new XWiki.widgets.Notification('$errorOnEdit', 'error', '20');
          return;
        }
        let params = {
          taskDocument: task.id,
        };
        let hasDueDate = !task.custom_class.split(/\s+/).includes('noDueDate');
        if(newEndDate.getTime() != task.editHack.oldEndDate.getTime()) {
          params.endDate = newEndDate.getTime();
        }
        if(newStartDate.getTime() != task.editHack.oldStartDate.getTime()) {
          params.startDate = newStartDate.getTime();
        }
        jQuery.ajax( updateService + new URLSearchParams(params) ).success(function(data) {
          if (data.success == true) {
            fetch_and_redraw(task);
          } else {
            console.log(data);
            new XWiki.widgets.Notification(escapeHTML(data.reason), 'error', '20');
          }
        }).error(e =&gt; console.log('Error when updating dates:', e));
      },
    });
  });
});
// ]]&gt;
&lt;/script&gt;
&lt;h3&gt;&lt;b&gt;
 Gantt Diagram##
#if ($macro.params.assignees), with assignees
   #foreach($assignee in $xcontext.macro.params.assignees)
     $assignee
   #end
#end
#if ($xcontext.macro.params.from), from ${xcontext.macro.params.from}#end
#if ($xcontext.macro.params.to)
   , to ${xcontext.macro.params.to}
 #end
 #if ($xcontext.macro.params.assignees)
   , with assignees
   #foreach($assignee in $xcontext.macro.params.assignees.split(','))
     #set($user = $xwiki.getUser($assignee).getUser())
     &lt;a class="xwiki-mention user" href="$xwiki.getDocument($user.getFullName()).getURL()"&gt;$user.getFullName()&lt;/a&gt;
   #end
 #end
&lt;/b&gt;&lt;/h3&gt;
&lt;/div&gt;
{{/html}}
#end
{{/velocity}}</code>
    </property>
    <property>
      <contentDescription/>
    </property>
    <property>
      <contentJavaType/>
    </property>
    <property>
      <contentType>No content</contentType>
    </property>
    <property>
      <defaultCategory/>
    </property>
    <property>
      <description>Display the Tasks registered with the Task Manager application in a gantt diagram.</description>
    </property>
    <property>
      <id>taskgantt</id>
    </property>
    <property>
      <name>Gantt Diagram</name>
    </property>
    <property>
      <priority/>
    </property>
    <property>
      <supportsInlineMode>0</supportsInlineMode>
    </property>
    <property>
      <visibility>Current Wiki</visibility>
    </property>
  </object>
  <object>
    <name>TaskManager.GanttMacro.Macro</name>
    <number>0</number>
    <className>XWiki.WikiMacroParameterClass</className>
    <guid>d8cfcc42-1da4-4ee0-b768-fff9a98938af</guid>
    <class>
      <name>XWiki.WikiMacroParameterClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <defaultValue>
        <disabled>0</disabled>
        <name>defaultValue</name>
        <number>4</number>
        <prettyName>Parameter default value</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </defaultValue>
      <description>
        <disabled>0</disabled>
        <name>description</name>
        <number>2</number>
        <prettyName>Parameter description</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </description>
      <mandatory>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>mandatory</name>
        <number>3</number>
        <prettyName>Parameter mandatory</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </mandatory>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Parameter name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <type>
        <disabled>0</disabled>
        <name>type</name>
        <number>5</number>
        <prettyName>Parameter type</prettyName>
        <size>60</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </type>
    </class>
    <property>
      <defaultValue/>
    </property>
    <property>
      <description>Only show tasks which started after the specified date.</description>
    </property>
    <property>
      <mandatory>0</mandatory>
    </property>
    <property>
      <name>from</name>
    </property>
    <property>
      <type>com.xwiki.date.DateType</type>
    </property>
  </object>
  <object>
    <name>TaskManager.GanttMacro.Macro</name>
    <number>1</number>
    <className>XWiki.WikiMacroParameterClass</className>
    <guid>d437a729-785d-4661-9634-06c146e4919b</guid>
    <class>
      <name>XWiki.WikiMacroParameterClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <defaultValue>
        <disabled>0</disabled>
        <name>defaultValue</name>
        <number>4</number>
        <prettyName>Parameter default value</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </defaultValue>
      <description>
        <disabled>0</disabled>
        <name>description</name>
        <number>2</number>
        <prettyName>Parameter description</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </description>
      <mandatory>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>mandatory</name>
        <number>3</number>
        <prettyName>Parameter mandatory</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </mandatory>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Parameter name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <type>
        <disabled>0</disabled>
        <name>type</name>
        <number>5</number>
        <prettyName>Parameter type</prettyName>
        <size>60</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </type>
    </class>
    <property>
      <defaultValue/>
    </property>
    <property>
      <description>Only show Tasks assigned to these Users. Comma separated format: "XWiki.User1,XWiki.User2"</description>
    </property>
    <property>
      <mandatory>0</mandatory>
    </property>
    <property>
      <name>assignees</name>
    </property>
    <property>
      <type>com.xwiki.task.UserReferenceList</type>
    </property>
  </object>
  <object>
    <name>TaskManager.GanttMacro.Macro</name>
    <number>2</number>
    <className>XWiki.WikiMacroParameterClass</className>
    <guid>3723e1b2-9d58-409a-8c62-81373612d2a8</guid>
    <class>
      <name>XWiki.WikiMacroParameterClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <defaultValue>
        <disabled>0</disabled>
        <name>defaultValue</name>
        <number>4</number>
        <prettyName>Parameter default value</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </defaultValue>
      <description>
        <disabled>0</disabled>
        <name>description</name>
        <number>2</number>
        <prettyName>Parameter description</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </description>
      <mandatory>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>mandatory</name>
        <number>3</number>
        <prettyName>Parameter mandatory</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </mandatory>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Parameter name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <type>
        <disabled>0</disabled>
        <name>type</name>
        <number>5</number>
        <prettyName>Parameter type</prettyName>
        <size>60</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </type>
    </class>
    <property>
      <defaultValue/>
    </property>
    <property>
      <description/>
    </property>
    <property>
      <mandatory/>
    </property>
    <property>
      <name>projects</name>
    </property>
    <property>
      <type/>
    </property>
  </object>
  <object>
    <name>TaskManager.GanttMacro.Macro</name>
    <number>3</number>
    <className>XWiki.WikiMacroParameterClass</className>
    <guid>4944f8c4-514a-4ad0-bae6-f97f48eca815</guid>
    <class>
      <name>XWiki.WikiMacroParameterClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <defaultValue>
        <disabled>0</disabled>
        <name>defaultValue</name>
        <number>4</number>
        <prettyName>Parameter default value</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </defaultValue>
      <description>
        <disabled>0</disabled>
        <name>description</name>
        <number>2</number>
        <prettyName>Parameter description</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </description>
      <mandatory>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>mandatory</name>
        <number>3</number>
        <prettyName>Parameter mandatory</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </mandatory>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Parameter name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <type>
        <disabled>0</disabled>
        <name>type</name>
        <number>5</number>
        <prettyName>Parameter type</prettyName>
        <size>60</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </type>
    </class>
    <property>
      <defaultValue/>
    </property>
    <property>
      <description>Only show tasks which end before the specified date.</description>
    </property>
    <property>
      <mandatory>0</mandatory>
    </property>
    <property>
      <name>to</name>
    </property>
    <property>
      <type>com.xwiki.date.DateType</type>
    </property>
  </object>
  <object>
    <name>TaskManager.GanttMacro.Macro</name>
    <number>4</number>
    <className>XWiki.WikiMacroParameterClass</className>
    <guid>2ed2ab1f-83c1-4d15-9674-c2d08b311356</guid>
    <class>
      <name>XWiki.WikiMacroParameterClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <defaultValue>
        <disabled>0</disabled>
        <name>defaultValue</name>
        <number>4</number>
        <prettyName>Parameter default value</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </defaultValue>
      <description>
        <disabled>0</disabled>
        <name>description</name>
        <number>2</number>
        <prettyName>Parameter description</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </description>
      <mandatory>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>mandatory</name>
        <number>3</number>
        <prettyName>Parameter mandatory</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </mandatory>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Parameter name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <type>
        <disabled>0</disabled>
        <name>type</name>
        <number>5</number>
        <prettyName>Parameter type</prettyName>
        <size>60</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </type>
    </class>
    <property>
      <defaultValue>true</defaultValue>
    </property>
    <property>
      <description>Whether users can modify tasks using the Gantt Diagram UI.</description>
    </property>
    <property>
      <mandatory>0</mandatory>
    </property>
    <property>
      <name>readonly</name>
    </property>
    <property>
      <type>java.lang.Boolean</type>
    </property>
  </object>
  <object>
    <name>TaskManager.GanttMacro.Macro</name>
    <number>5</number>
    <className>XWiki.WikiMacroParameterClass</className>
    <guid>d2d9eeb2-04e0-46a7-ad91-68f472c7f2b7</guid>
    <class>
      <name>XWiki.WikiMacroParameterClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <defaultValue>
        <disabled>0</disabled>
        <name>defaultValue</name>
        <number>4</number>
        <prettyName>Parameter default value</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </defaultValue>
      <description>
        <disabled>0</disabled>
        <name>description</name>
        <number>2</number>
        <prettyName>Parameter description</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </description>
      <mandatory>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>mandatory</name>
        <number>3</number>
        <prettyName>Parameter mandatory</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </mandatory>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Parameter name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <type>
        <disabled>0</disabled>
        <name>type</name>
        <number>5</number>
        <prettyName>Parameter type</prettyName>
        <size>60</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </type>
    </class>
    <property>
      <defaultValue/>
    </property>
    <property>
      <description>The spaces in which to look for tasks, comma separated.</description>
    </property>
    <property>
      <mandatory>0</mandatory>
    </property>
    <property>
      <name>spaces</name>
    </property>
    <property>
      <type/>
    </property>
  </object>
  <object>
    <name>TaskManager.GanttMacro.Macro</name>
    <number>6</number>
    <className>XWiki.WikiMacroParameterClass</className>
    <guid>22aae958-b74c-4751-ada4-334cf624f390</guid>
    <class>
      <name>XWiki.WikiMacroParameterClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <defaultValue>
        <disabled>0</disabled>
        <name>defaultValue</name>
        <number>4</number>
        <prettyName>Parameter default value</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </defaultValue>
      <description>
        <disabled>0</disabled>
        <name>description</name>
        <number>2</number>
        <prettyName>Parameter description</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </description>
      <mandatory>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>mandatory</name>
        <number>3</number>
        <prettyName>Parameter mandatory</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </mandatory>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Parameter name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <type>
        <disabled>0</disabled>
        <name>type</name>
        <number>5</number>
        <prettyName>Parameter type</prettyName>
        <size>60</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </type>
    </class>
    <property>
      <defaultValue>true</defaultValue>
    </property>
    <property>
      <description>Hide tasks which have no due date set, and as such cannot be displayed properly in the diagram. If set to false, the default duration of such a task is set to one week.</description>
    </property>
    <property>
      <mandatory>0</mandatory>
    </property>
    <property>
      <name>hideNoDueDate</name>
    </property>
    <property>
      <type>java.lang.Boolean</type>
    </property>
  </object>
</xwikidoc>
